{% extends "projects/base_project.html" %}

{% load core_tags docs_italia i18n static %}

{% block title %}
  {% blocktrans with query=query|default:"" %}Search: {{ query }}{% endblocktrans %}
{% endblock %}

{% block content %}
<div class="navigable">
  <div class="container">
    <div class="row">
      <!-- Start filters -->
      <div class="col-12 col-md-4">
        <div class="link-list-wrapper">
          {% if query and results.hits.hits|length > 0 %}
            <!-- publisher filters -->
            {% if facets.publisher %}
              <ul class="link-list serp-search-filters">
                <li class="serp-filter-title">
                  <svg class="icon icon-secondary icon-sm">
                    <use xlink:href="{% get_static_prefix %}vendor/bootstrap-italia/svg/sprite.svg#it-pa"></use>
                  </svg>
                  <h3>Amministrazione</h3>
                </li>

                {% for name, count, selected in facets.publisher %}
                  <li>
                    <a class="p-0 d-inline-block" href="?{% if publisher == name %}{% url_replace request 'publisher' '' %}{% else %}{% url_replace request 'publisher' name %}{% endif %}">
                      <div class="form-check">
                        <input id="{{name}}" type="checkbox" {% if selected %}checked="true"{% endif %}>
                        <label for="{{name}}">{{name}} <span>({{ count }})</span></label>
                      </div>
                    </a>
                  </li>
                {% endfor %}
              </ul>
           {% endif %}

           <!-- projects filters -->
           {% if facets.publisher_project %}
           <ul class="link-list serp-search-filters">
              <li class="serp-filter-title">
                <svg class="icon icon-secondary icon-sm">
                  <use xlink:href="{% get_static_prefix %}vendor/bootstrap-italia/svg/sprite.svg#it-folder"></use>
                </svg>
                <h3>Progetto</h3>
              </li>

              {% for name, count, selected in facets.publisher_project %}
                <li>
                  <a class="p-0 d-inline-block" href="?{% if publisher_project == name %}{% url_replace request 'publisher_project' '' %}{% else %}{% url_replace request 'publisher_project' name %}{% endif %}">
                    <div class="form-check">
                      <input id="{{name}}" type="checkbox" {% if selected %}checked="true"{% endif %}>
                      <label for="{{name}}">{{name|get_publisher_project}} <span>({{ count }})</span></label>
                    </div>
                  </a>
                </li>
              {% endfor %}
            </ul>
            {% endif %}
          {% endif %}
        </div>
      </div>
      <!-- End filters -->

      <!-- Right content -->
      <div class="col-12 col-md-8">
        <h1 class="main-title py-2 neutral-1-color">Risultati per: {{ query }}</h1>

        <div class="serp-results-info mt-5 pb-2">
          <p class="mb-0">
            {% if results|length == 1 %}
              <strong>{{results|length}} risultato</strong>
            {% else %}
              <strong>{{results|length}} risultati</strong>
            {% endif %}
          </p>

          <div class="serp-results-order">
            <label for="order-select" class="mr-2">Ordina per</label>
            <select id="order-select" title="Scegli una opzione">
              <option value="1">Rilevanza</option>
              <option value="2">Pi√π recente</option>
              <option value="3">Meno recente</option>
              <option value="4">Ordine alfabetico</option>
            </select>
          </div>
        </div>

        {% if query %}
          <!-- BEGIN search results -->
          <div class="module">

            <ul class="row">
              {% for result in results %}
              <li class="document-card col-12 col-md-4 item p-2 p-md-3">
                <p class="document-card-header icon-type-document neutral-1-color-a8">{{ result.publisher }}</p>
                {% if type == "project" %}
                  {# Project #}
                  <h3 class="document-card-title color-inherit">
                    <a href="{% doc_url_patched result.slug|get_project %}">{{ result.name }}</a>
                  </h3>
                  <div class="document-card-description color-inherit">
                    {% for fragment in result.meta.highlight.description|slice:":1" %}
                    <p>
                      ...{{ fragment|safe }}...
                    </p>
                    {% endfor %}
                  </div>
                  {# End Project #}
                {% elif type == "file" %}
                  {# File #}
                  <h3 class="document-card-title color-inherit">
                    {% with result.project|get_project as proj %}
                    <a href="{% doc_url_patched proj result.version result.full_path %}?highlight={{ query }}">{{ proj }} - {{ result.title|safe }}</a>
                    {% endwith %}
                  </h3>
                  <div class="document-card-description color-inherit">
                    {% for inner_hit in result.meta.inner_hits|slice:":1" %}
                        {% if inner_hit.type == 'sections' %}

                          {% if inner_hit.highlight|get_key_or_none:"sections.content" %}
                            {% with section_content=inner_hit.highlight|get_key_or_none:"sections.content" %}
                              {% for content in section_content %}
                                <p class="fragment">
                                  ... {{ content|safe }} ...
                                </p>
                              {% endfor %}
                            {% endwith %}
                          {% else %}
                            <p class="fragment">
                              {{ inner_hit.source.content|safe }} ...
                            </p>
                          {% endif %}
                        {% endif %}
                    {% endfor %}
                  </div>
                  {# End File #}
                {% endif %}
              </li>
              {% empty %}
              <li class="text-center d-block w-100 lead mt-5">
                {% trans "No results found. Bummer." %}
              </li>
              {% endfor %}
            </ul>

          </div>
          <!-- END search results -->

          {% if page.has_previous or page.has_next %}
          <!-- BEGIN search pagination -->
          <!-- <div class="pagination">
            {% if page.has_previous %}
            <a href="?q={{ query }}&amp;page={{ page.previous_page_number }}">&laquo; {% trans "Previous" %}</a>
            {% else %}
            <span class="disabled">&laquo; {% trans "Previous" %}</span>
            {% endif %}

            {% if page.has_next %}
            <a class="next" href="?q={{ query }}&amp;page={{ page.next_page_number }}">{% trans "Next" %} &raquo;</a>
            {% else %}
            <span class="next disabled">{% trans "Next" %} &raquo;</span>
            {% endif %}
          </div> -->
          <!-- END search pagination -->
          {% endif %}
        {% else %}
          {# Show some example queries to run, maybe query syntax, something else? #}
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
